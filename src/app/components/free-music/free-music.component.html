<div class="free-music">
  <header class="header">
    <h1>Free Music</h1>
    <p class="subtitle">Search and play royalty-free tracks from Audius (no copyright)</p>
    <div class="search-row">
      <input
        type="text"
        class="search-input"
        placeholder="Search tracks, artists..."
        [ngModel]="query()"
        (ngModelChange)="query.set($event)"
        (keyup.enter)="onSearch()"
      />
      <button type="button" class="search-btn" (click)="onSearch()">Search</button>
    </div>
    @if (recentSearches().length > 0) {
      <div class="recent-searches">
        <span class="recent-label">Recent:</span>
        @for (term of recentSearches(); track term) {
          <button type="button" class="recent-chip" (click)="runRecentSearch(term)">
            {{ term }}
          </button>
        }
      </div>
    }
  </header>

  @if (error()) {
    <p class="error">{{ error() }}</p>
  }

  @if (loading()) {
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Searching…</p>
    </div>
  } @else if (tracks().length > 0) {
    <section class="section">
      <h2 class="section-title">Results</h2>
      <div class="grid tracks-grid">
        @for (track of tracks(); track track.id) {
          <div class="track-card-wrap">
            <button type="button" class="track-card" (click)="onTrackClick(track)">
              <div class="cover-wrap">
                @if (brokenCoverIds().has(track.id)) {
                  <div class="cover-fallback" aria-hidden="true">♪</div>
                } @else {
                  <img [src]="artworkUrl(track)" [alt]="track.title" class="cover" (error)="onCoverError(track.id)" />
                }
                <span class="play-overlay" aria-hidden="true">
                <svg class="icon-play" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7L8 5z"/></svg>
              </span>
              </div>
              <span class="name">{{ track.title }}</span>
              @if (track.user?.name) {
                <span class="artist">{{ track.user?.name }}</span>
              }
              <span class="duration">{{ formatDuration(track.duration) }}</span>
            </button>
            <button
              type="button"
              class="add-to-playlist-btn"
              (click)="openAddToPlaylist(track.id, $event)"
              [attr.aria-expanded]="addToPlaylistTrackId() === track.id"
              aria-label="Add to playlist"
              title="Add to playlist"
            >
              <svg class="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
            </button>
            @if (addToPlaylistTrackId() === track.id) {
              <div
                class="add-to-playlist-dropdown"
                [class.dropdown-open-left]="addToPlaylistDropdownLeft()"
                (click)="$event.stopPropagation()"
              >
                <p class="dropdown-title">Add to playlist</p>
                @if (playlistService.playlistsList().length === 0) {
                  <p class="dropdown-empty">No playlists yet.</p>
                } @else {
                  @for (playlist of playlistService.playlistsList(); track playlist.id) {
                    <button
                      type="button"
                      class="dropdown-item"
                      (click)="addTrackToPlaylist(playlist.id, track.id)"
                    >
                      {{ playlist.name }}
                    </button>
                  }
                }
                <button
                  type="button"
                  class="dropdown-item dropdown-item-new"
                  (click)="createPlaylistAndAddTrack(track.id)"
                >
                  Create new playlist
                </button>
              </div>
            }
          </div>
        }
      </div>
      <div class="pagination">
        <span class="pagination-info">
          Page {{ page() }}
          @if (!hasNextPage() && page() === 1 && tracks().length > 0) {
            <span class="pagination-hint">(one page — {{ tracks().length }} results)</span>
          }
        </span>
        <div class="pagination-btns">
          <button
            type="button"
            class="pagination-btn"
            (click)="goToPrevPage()"
            [disabled]="page() <= 1 || loading()"
            aria-label="Previous page"
          >
            ‹ Previous
          </button>
          <button
            type="button"
            class="pagination-btn"
            (click)="goToNextPage()"
            [disabled]="!hasNextPage() || loading()"
            aria-label="Next page"
          >
            Next ›
          </button>
        </div>
      </div>
    </section>
  } @else {
    <p class="empty">Enter a search term and click Search to find free music.</p>
  }
</div>
