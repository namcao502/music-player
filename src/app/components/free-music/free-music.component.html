<div class="free-music">
  <header class="header">
    <h1>Free Music</h1>
    <p class="subtitle">Search and play royalty-free tracks from Audius (no copyright)</p>
    <div class="search-row">
      <input
        type="text"
        class="search-input"
        placeholder="Search tracks, artists..."
        [ngModel]="query()"
        (ngModelChange)="query.set($event)"
        (keyup.enter)="onSearch()"
      />
      <button type="button" class="search-btn" (click)="onSearch()">Search</button>
    </div>
    @if (recentSearches().length > 0) {
      <div class="recent-searches">
        <span class="recent-label">Recent:</span>
        @for (term of recentSearches(); track term) {
          <button type="button" class="recent-chip" (click)="runRecentSearch(term)">
            {{ term }}
          </button>
        }
        <button type="button" class="recent-clear" (click)="clearRecentSearches()" title="Clear recent searches">Clear</button>
      </div>
    }
  </header>

  @if (error()) {
    <p class="error">{{ error() }}</p>
  }

  @if (loading()) {
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Searching…</p>
    </div>
  } @else if (tracks().length > 0) {
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">Results</h2>
        <div class="sort-controls">
          <span class="sort-label">Sort:</span>
          <div class="sort-dropdown-wrap">
            <button type="button" class="sort-trigger" (click)="toggleSortDropdown($event)">
              {{ sortLabel() }}
              <svg class="sort-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
            </button>
            @if (sortDropdownOpen()) {
              <div class="sort-dropdown" (click)="$event.stopPropagation()">
                <button type="button" class="sort-option" [class.active]="sortMode() === 'default'" (click)="selectSortMode('default')">Default</button>
                <button type="button" class="sort-option" [class.active]="sortMode() === 'duration-asc'" (click)="selectSortMode('duration-asc')">Duration (short first)</button>
                <button type="button" class="sort-option" [class.active]="sortMode() === 'duration-desc'" (click)="selectSortMode('duration-desc')">Duration (long first)</button>
                <button type="button" class="sort-option" [class.active]="sortMode() === 'artist'" (click)="selectSortMode('artist')">Artist name</button>
              </div>
            }
          </div>
        </div>
      </div>
      <div class="grid tracks-grid">
        @for (track of sortedTracks(); track track.id) {
          <div class="track-card-wrap">
            <button type="button" class="track-card" (click)="onTrackClick(track)">
              <div class="cover-wrap">
                @if (brokenCoverIds().has(track.id)) {
                  <div class="cover-fallback" aria-hidden="true">♪</div>
                } @else {
                  <img [src]="artworkUrl(track)" [alt]="track.title" class="cover" (error)="onCoverError(track.id)" />
                }
                <span class="play-overlay" aria-hidden="true">
                <svg class="icon-play" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7L8 5z"/></svg>
              </span>
              </div>
              <span class="name">{{ track.title }}</span>
              @if (track.user?.name) {
                <a class="artist artist-link" [routerLink]="['/artist', track.user!.id]" (click)="$event.stopPropagation()">{{ track.user?.name }}</a>
              }
              <span class="duration">{{ formatDuration(track.duration) }}</span>
            </button>
            <button
              type="button"
              class="fav-btn"
              [class.is-fav]="favoritesService.isFavorite(track.id)"
              (click)="toggleFavorite(track.id, $event)"
              [attr.aria-label]="favoritesService.isFavorite(track.id) ? 'Remove from favorites' : 'Add to favorites'"
              [attr.title]="favoritesService.isFavorite(track.id) ? 'Remove from favorites' : 'Add to favorites'"
            >
              <svg class="icon-heart" viewBox="0 0 24 24" aria-hidden="true">
                @if (favoritesService.isFavorite(track.id)) {
                  <path fill="currentColor" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                } @else {
                  <path fill="none" stroke="currentColor" stroke-width="2" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                }
              </svg>
            </button>
            <button
              type="button"
              class="add-to-playlist-btn"
              (click)="openAddToPlaylist(track.id, $event)"
              [attr.aria-expanded]="addToPlaylistTrackId() === track.id"
              aria-label="Add to playlist"
              title="Add to playlist"
            >
              <svg class="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
            </button>
            @if (addToPlaylistTrackId() === track.id) {
              <div
                class="add-to-playlist-dropdown"
                [class.dropdown-open-left]="addToPlaylistDropdownLeft()"
                (click)="$event.stopPropagation()"
              >
                <p class="dropdown-title">Add to playlist</p>
                @if (playlistService.playlistsList().length === 0) {
                  <p class="dropdown-empty">No playlists yet.</p>
                } @else {
                  @for (playlist of playlistService.playlistsList(); track playlist.id) {
                    <button
                      type="button"
                      class="dropdown-item"
                      (click)="addTrackToPlaylist(playlist.id, track.id)"
                    >
                      {{ playlist.name }}
                    </button>
                  }
                }
                <button
                  type="button"
                  class="dropdown-item dropdown-item-new"
                  (click)="createPlaylistAndAddTrack(track.id)"
                >
                  Create new playlist
                </button>
              </div>
            }
          </div>
        }
      </div>
      <div class="pagination">
        <span class="pagination-info">
          Page {{ page() }}
          @if (!hasNextPage() && page() === 1 && tracks().length > 0) {
            <span class="pagination-hint">(one page — {{ tracks().length }} results)</span>
          }
        </span>
        <div class="pagination-btns">
          <button
            type="button"
            class="pagination-btn"
            (click)="goToPrevPage()"
            [disabled]="page() <= 1 || loading()"
            aria-label="Previous page"
          >
            ‹ Previous
          </button>
          <button
            type="button"
            class="pagination-btn"
            (click)="goToNextPage()"
            [disabled]="!hasNextPage() || loading()"
            aria-label="Next page"
          >
            Next ›
          </button>
        </div>
      </div>
    </section>
  } @else {
    <p class="empty">Enter a search term and click Search to find free music.</p>
  }
</div>
