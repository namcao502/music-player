<audio #audioEl class="audio-el"></audio>
@if (player.nowPlaying(); as np) {
  <div class="player-bar">

    <div class="now-playing">
      <button
        type="button"
        class="now-playing-cover-btn"
        (click)="player.togglePlayPause()"
        [attr.aria-label]="player.isPlaying() ? 'Pause' : 'Play'"
      >
        @if (coverError()) {
          <span class="cover-fallback" aria-hidden="true">♪</span>
        } @else {
          <img [src]="coverUrl(np.track)" [alt]="np.track.title" class="cover" (error)="coverError.set(true)" />
        }
        <span class="now-playing-cover-icon" aria-hidden="true">
          @if (player.isPlaying()) {
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>
          } @else {
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7L8 5z"/></svg>
          }
        </span>
      </button>
      <div class="info">
        <span class="title">{{ np.track.title }}</span>
        @if (np.track.artist || np.track.album) {
          <span class="meta">{{ np.track.artist }}{{ np.track.artist && np.track.album ? ' · ' : '' }}{{ np.track.album }}</span>
        }
      </div>
    </div>

    <div class="center-controls">
      <div class="controls">
        <button
          type="button"
          class="control-toggle"
          (click)="player.toggleShuffle()"
          [class.is-active]="player.shuffleEnabled()"
          aria-label="Toggle shuffle"
          [attr.aria-pressed]="player.shuffleEnabled()"
          title="Shuffle"
        >
          <svg class="icon icon-shuffle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M16 3h5v5" />
            <path d="M4 20l16-16" />
            <path d="M21 16v5h-5" />
            <path d="M4 4l6 6" />
            <path d="M14 14l6 6" />
          </svg>
        </button>
        <button type="button" (click)="player.previous()" aria-label="Previous">
          <svg class="icon icon-prev-next" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z"/></svg>
        </button>
        <button type="button" class="control-play-pause" (click)="player.togglePlayPause()" [attr.aria-label]="player.isPlaying() ? 'Pause' : 'Play'">
          @if (player.isPlaying()) {
            <svg class="icon icon-play-pause" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>
          } @else {
            <svg class="icon icon-play-pause" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7L8 5z"/></svg>
          }
        </button>
        <button type="button" (click)="player.next()" aria-label="Next">
          <svg class="icon icon-prev-next" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 18l8.5-6L6 6v12zm10-12v12h2V6h-2z"/></svg>
        </button>
        <button
          type="button"
          class="control-toggle"
          (click)="player.cycleLoopMode()"
          [class.is-active]="player.loopMode() !== 'off'"
          aria-label="Change loop mode"
          title="Loop"
        >
          <svg class="icon icon-loop" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M17 2l4 4-4 4" />
            <path d="M3 11V9a4 4 0 0 1 4-4h14" />
            <path d="M7 22l-4-4 4-4" />
            <path d="M21 13v2a4 4 0 0 1-4 4H3" />
          </svg>
          @if (player.loopMode() === 'one') {
            <span class="loop-one-badge" aria-hidden="true">1</span>
          }
        </button>
      </div>
      <div class="progress-wrap">
        <span class="time time-current">{{ formatDuration(currentTime()) }}</span>
        <input
          type="range"
          class="progress"
          [min]="0"
          [max]="duration() || 1"
          [value]="currentTime()"
          (input)="onSeekInput($any($event.target).valueAsNumber)"
          (change)="onSeekChange($any($event.target).valueAsNumber)"
          aria-label="Seek"
        />
        <span class="time time-total">{{ formatDuration(duration()) }}</span>
      </div>
    </div>

    <div class="right-controls">
      <div class="volume-wrap">
        <svg class="icon icon-volume" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          @if (volume() === 0) {
            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
          } @else if (volume() < 0.5) {
            <path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 9v6h4l5 5V4L9 9H5z"/>
          } @else {
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
          }
        </svg>
        <input
          type="range"
          class="volume-slider"
          min="0"
          max="1"
          step="0.01"
          [value]="volume()"
          (input)="onVolumeInput($any($event.target).valueAsNumber)"
          aria-label="Volume"
        />
      </div>
      <button
        type="button"
        class="queue-btn"
        (click)="toggleQueue()"
        [attr.aria-label]="showQueue() ? 'Hide queue' : 'Show queue'"
        [attr.aria-expanded]="showQueue()"
      >
        <svg class="icon icon-queue" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/></svg>
        <span>Queue</span>
      </button>
    </div>
  </div>

  @if (showQueue()) {
    <div class="queue-backdrop" (click)="toggleQueue()" aria-hidden="true"></div>
    <div class="queue-panel">
      <div class="queue-panel-header">
        <span class="queue-panel-title">Up next</span>
        @if (player.queueList().length > 0) {
          <span class="queue-panel-duration">{{ formatDuration(totalQueueDuration()) }}</span>
          <button type="button" class="queue-panel-clear" (click)="onClearQueue()" aria-label="Clear queue" title="Clear queue">Clear</button>
        }
        <button type="button" class="queue-panel-close" (click)="toggleQueue()" aria-label="Close queue">
          <svg class="icon icon-close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <ul class="queue-list">
        @if (player.queueList().length === 0) {
          <li class="queue-item queue-item-empty">No tracks in queue</li>
        } @else {
          @for (track of player.queueList(); track track.id; let i = $index) {
            <li
              class="queue-item"
              [class.queue-item-current]="isCurrentTrack(track.id)"
              (click)="playFromQueue(i)"
              role="button"
              tabindex="0"
              (keydown.enter)="playFromQueue(i)"
              (keydown.space)="playFromQueue(i); $event.preventDefault()"
            >
              <div class="queue-item-cover">
                @if (queueCoverErrors().has(track.id)) {
                  <span class="queue-cover-fallback" aria-hidden="true">♪</span>
                } @else {
                  <img [src]="coverUrl(track)" [alt]="" (error)="onQueueCoverError(track.id)" />
                }
              </div>
              <span class="queue-item-index">{{ i + 1 }}</span>
              @if (isCurrentTrack(track.id) && player.isPlaying()) {
                <span class="queue-now-playing-anim" aria-hidden="true">
                  <span class="eq-bar"></span>
                  <span class="eq-bar"></span>
                  <span class="eq-bar"></span>
                </span>
              }
              <span class="queue-item-title">{{ track.title }}</span>
              @if (track.artist) {
                <span class="queue-item-artist">{{ track.artist }}</span>
              }
              <span class="queue-item-duration">{{ formatDuration(track.duration) }}</span>
              <button
                type="button"
                class="queue-item-add-btn"
                (click)="openQueueAddToPlaylist(track.id, $event)"
                [attr.aria-expanded]="queueAddToPlaylistTrackId() === track.id"
                aria-label="Add to playlist"
                title="Add to playlist"
              >
                <svg class="icon icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><path d="M12 5v14M5 12h14"/></svg>
              </button>
              @if (queueAddToPlaylistTrackId() === track.id) {
                <div class="queue-add-dropdown" (click)="$event.stopPropagation()">
                  <p class="queue-dropdown-title">Add to playlist</p>
                  @if (playlistService.playlistsList().length === 0) {
                    <p class="queue-dropdown-empty">No playlists yet.</p>
                  } @else {
                    @for (playlist of playlistService.playlistsList(); track playlist.id) {
                      <button
                        type="button"
                        class="queue-dropdown-item"
                        (click)="addQueueTrackToPlaylist(playlist.id, track.id)"
                      >
                        {{ playlist.name }}
                      </button>
                    }
                  }
                  <button
                    type="button"
                    class="queue-dropdown-item queue-dropdown-item-new"
                    (click)="createPlaylistAndAddQueueTrack(track.id)"
                  >
                    Create new playlist
                  </button>
                </div>
              }
            </li>
          }
        }
      </ul>
      <div class="queue-panel-footer">
        <label class="crossfade-label">
          Crossfade
          <input
            type="range"
            class="crossfade-slider"
            min="0"
            max="12"
            step="1"
            [value]="player.crossfadeDuration()"
            (input)="player.setCrossfadeDuration($any($event.target).valueAsNumber)"
            aria-label="Crossfade duration"
          />
          <span class="crossfade-value">{{ player.crossfadeDuration() }}s</span>
        </label>
      </div>
    </div>
  }
}
