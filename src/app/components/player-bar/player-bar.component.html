<audio #audioEl class="audio-el"></audio>
@if (player.nowPlaying(); as np) {
  <div class="player-bar">

    <div class="now-playing">
      <button
        type="button"
        class="now-playing-cover-btn"
        (click)="player.togglePlayPause()"
        [attr.aria-label]="player.isPlaying() ? 'Pause' : 'Play'"
      >
        @if (coverError()) {
          <span class="cover-fallback" aria-hidden="true">♪</span>
        } @else {
          <img [src]="coverUrl(np.track)" [alt]="np.track.title" class="cover" (error)="coverError.set(true)" />
        }
        <span class="now-playing-cover-icon">{{ player.isPlaying() ? '‖' : '▶' }}</span>
      </button>
      <div class="info">
        <span class="title">{{ np.track.title }}</span>
        @if (np.track.artist || np.track.album) {
          <span class="meta">{{ np.track.artist }}{{ np.track.artist && np.track.album ? ' · ' : '' }}{{ np.track.album }}</span>
        }
      </div>
    </div>

    <div class="center-controls">
      <div class="controls">
        <button type="button" (click)="player.previous()" aria-label="Previous">‹</button>
        <button type="button" (click)="player.togglePlayPause()" [attr.aria-label]="player.isPlaying() ? 'Pause' : 'Play'">
          {{ player.isPlaying() ? '‖' : '▶' }}
        </button>
        <button type="button" (click)="player.next()" aria-label="Next">›</button>
      </div>
      <div class="progress-wrap">
        <span class="time time-current">{{ formatDuration(currentTime()) }}</span>
        <input
          type="range"
          class="progress"
          [min]="0"
          [max]="duration() || 1"
          [value]="currentTime()"
          (input)="onSeekInput($any($event.target).valueAsNumber)"
          (change)="onSeekChange($any($event.target).valueAsNumber)"
          aria-label="Seek"
        />
        <span class="time time-total">{{ formatDuration(duration()) }}</span>
      </div>
    </div>

    <div class="queue-toggle-wrap">
      <button
        type="button"
        class="queue-btn"
        (click)="toggleQueue()"
        [attr.aria-label]="showQueue() ? 'Hide queue' : 'Show queue'"
        [attr.aria-expanded]="showQueue()"
      >
        ☰ Queue
      </button>
    </div>
  </div>

  @if (showQueue()) {
    <div class="queue-panel">
      <div class="queue-panel-header">
        <span class="queue-panel-title">Up next</span>
        <button type="button" class="queue-panel-close" (click)="toggleQueue()" aria-label="Close queue">×</button>
      </div>
      <ul class="queue-list">
        @if (player.queueList().length === 0) {
          <li class="queue-item queue-item-empty">No tracks in queue</li>
        } @else {
          @for (track of player.queueList(); track track.id; let i = $index) {
            <li
              class="queue-item"
              [class.queue-item-current]="isCurrentTrack(track.id)"
              (click)="playFromQueue(i)"
              role="button"
              tabindex="0"
              (keydown.enter)="playFromQueue(i)"
              (keydown.space)="playFromQueue(i); $event.preventDefault()"
            >
              <div class="queue-item-cover">
                @if (queueCoverErrors().has(track.id)) {
                  <span class="queue-cover-fallback" aria-hidden="true">♪</span>
                } @else {
                  <img [src]="coverUrl(track)" [alt]="" (error)="onQueueCoverError(track.id)" />
                }
              </div>
              <span class="queue-item-index">{{ i + 1 }}</span>
              <span class="queue-item-title">{{ track.title }}</span>
              @if (track.artist) {
                <span class="queue-item-artist">{{ track.artist }}</span>
              }
              <span class="queue-item-duration">{{ formatDuration(track.duration) }}</span>
            </li>
          }
        }
      </ul>
    </div>
  }
}
