<audio #audioEl class="audio-el"></audio>
<div class="sr-only" aria-live="polite" aria-atomic="true">{{ nowPlayingAnnouncement() }}</div>
@if (player.nowPlaying(); as np) {
  <div class="player-bar" [class.mini-player]="miniMode()">

    <div class="now-playing">
      <button
        type="button"
        class="now-playing-cover-btn"
        (click)="player.togglePlayPause()"
        [attr.aria-label]="player.isPlaying() ? strings.BTN.PAUSE : strings.BTN.PLAY"
      >
        @if (coverError()) {
          <span class="cover-fallback" aria-hidden="true">♪</span>
        } @else {
          <img [src]="coverUrl(np.track)" [alt]="np.track.title" class="cover" (error)="coverError.set(true)" />
        }
        <span class="now-playing-cover-icon" aria-hidden="true">
          @if (player.isPlaying()) {
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>
          } @else {
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7L8 5z"/></svg>
          }
        </span>
      </button>
      <div class="info">
        <span class="title">{{ np.track.title }}</span>
        @if (np.track.artist || np.track.album) {
          <span class="meta">{{ np.track.artist }}{{ np.track.artist && np.track.album ? ' · ' : '' }}{{ np.track.album }}</span>
        }
      </div>
    </div>

    <div class="center-controls">
      @if (showVisualizer()) {
        <app-audio-visualizer [analyser]="analyserNode" />
      }
      <div class="controls">
        <button
          type="button"
          class="control-toggle"
          (click)="player.toggleShuffle()"
          [class.is-active]="player.shuffleEnabled()"
          [attr.aria-label]="'Toggle ' + strings.BTN.SHUFFLE"
          [attr.aria-pressed]="player.shuffleEnabled()"
          [attr.title]="strings.BTN.SHUFFLE"
        >
          <svg class="icon icon-shuffle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M16 3h5v5" />
            <path d="M4 20l16-16" />
            <path d="M21 16v5h-5" />
            <path d="M4 4l6 6" />
            <path d="M14 14l6 6" />
          </svg>
        </button>
        <button type="button" (click)="player.previous()" [attr.aria-label]="strings.BTN.PREVIOUS">
          <svg class="icon icon-prev-next" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z"/></svg>
        </button>
        <button type="button" class="control-play-pause" (click)="player.togglePlayPause()" [attr.aria-label]="player.isPlaying() ? strings.BTN.PAUSE : strings.BTN.PLAY">
          @if (player.isPlaying()) {
            <svg class="icon icon-play-pause" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>
          } @else {
            <svg class="icon icon-play-pause" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7L8 5z"/></svg>
          }
        </button>
        <button type="button" (click)="player.next()" [attr.aria-label]="strings.BTN.NEXT">
          <svg class="icon icon-prev-next" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 18l8.5-6L6 6v12zm10-12v12h2V6h-2z"/></svg>
        </button>
        <button
          type="button"
          class="control-toggle"
          (click)="player.cycleLoopMode()"
          [class.is-active]="player.loopMode() !== 'off'"
          [attr.aria-label]="'Change ' + strings.BTN.LOOP + ' mode'"
          [attr.title]="strings.BTN.LOOP"
        >
          <svg class="icon icon-loop" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M17 2l4 4-4 4" />
            <path d="M3 11V9a4 4 0 0 1 4-4h14" />
            <path d="M7 22l-4-4 4-4" />
            <path d="M21 13v2a4 4 0 0 1-4 4H3" />
          </svg>
          @if (player.loopMode() === 'one') {
            <span class="loop-one-badge" aria-hidden="true">1</span>
          }
        </button>
      </div>
      <div class="progress-wrap">
        <button type="button" class="seek-btn" (click)="seekRelative(-10)" [attr.aria-label]="strings.BTN.SEEK_BACK" [attr.title]="strings.BTN.SEEK_BACK">−10</button>
        <span class="time time-current">{{ formatDuration(currentTime()) }}</span>
        <input
          type="range"
          class="progress"
          [min]="0"
          [max]="duration() || 1"
          [value]="currentTime()"
          (input)="onSeekInput($any($event.target).valueAsNumber)"
          (change)="onSeekChange($any($event.target).valueAsNumber)"
          [attr.aria-label]="strings.BTN.SEEK"
        />
        <span class="time time-total">{{ formatDuration(duration()) }}</span>
        <button type="button" class="seek-btn" (click)="seekRelative(10)" [attr.aria-label]="strings.BTN.SEEK_FORWARD" [attr.title]="strings.BTN.SEEK_FORWARD">+10</button>
      </div>
    </div>

    <div class="right-controls">
      <!-- F4: Playback Speed -->
      <div class="speed-wrap desktop-only">
        <button type="button" class="speed-btn" (click)="toggleSpeedMenu(); $event.stopPropagation()" [attr.title]="strings.BTN.PLAYBACK_SPEED">
          {{ playbackSpeed() }}x
        </button>
        @if (speedMenuOpen()) {
          <div class="speed-menu" (click)="$event.stopPropagation()">
            @for (speed of SPEED_OPTIONS; track speed) {
              <button
                type="button"
                class="speed-option"
                [class.active]="playbackSpeed() === speed"
                (click)="setPlaybackSpeed(speed)"
              >
                {{ speed }}x
              </button>
            }
          </div>
        }
      </div>

      <div class="volume-wrap">
        <!-- F2: Mute Toggle — wrap SVG in button -->
        <button type="button" class="mute-btn" (click)="toggleMute()" [attr.aria-label]="volume() === 0 ? strings.BTN.UNMUTE : strings.BTN.MUTE" [attr.title]="strings.BTN.MUTE + ' / ' + strings.BTN.UNMUTE">
          <svg class="icon icon-volume" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            @if (volume() === 0) {
              <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
            } @else if (volume() < 0.5) {
              <path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 9v6h4l5 5V4L9 9H5z"/>
            } @else {
              <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
            }
          </svg>
        </button>
        <input
          type="range"
          class="volume-slider"
          min="0"
          max="1"
          step="0.01"
          [value]="volume()"
          (input)="onVolumeInput($any($event.target).valueAsNumber)"
          [attr.aria-label]="strings.BTN.VOLUME"
        />
      </div>

      <!-- F10: Visualizer Toggle -->
      <button type="button" class="icon-btn desktop-only" (click)="toggleVisualizer()" [class.is-active]="showVisualizer()" [attr.title]="strings.BTN.TOGGLE_VISUALIZER" [attr.aria-label]="strings.BTN.TOGGLE_VISUALIZER">
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 3v18m-4-14v10m-4-6v2m8-10v18m4-14v10m4-6v2"/></svg>
      </button>

      <!-- F9: Mini Mode Toggle -->
      <button type="button" class="icon-btn desktop-only" (click)="toggleMiniMode()" [class.is-active]="miniMode()" [attr.title]="strings.BTN.TOGGLE_MINI_PLAYER" [attr.aria-label]="strings.BTN.TOGGLE_MINI_PLAYER">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          @if (miniMode()) {
            <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
          } @else {
            <path d="M4 14h6v6M14 4h6v6M10 14l-7 7M21 3l-7 7"/>
          }
        </svg>
      </button>

      <button
        type="button"
        class="queue-btn"
        (click)="toggleQueue()"
        [attr.aria-label]="showQueue() ? strings.BTN.HIDE_QUEUE : strings.BTN.SHOW_QUEUE"
        [attr.aria-expanded]="showQueue()"
      >
        <svg class="icon icon-queue" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/></svg>
        <span>{{ strings.BTN.QUEUE }}</span>
      </button>
    </div>

    <!-- F9: Mini mode compact controls overlay -->
    @if (miniMode()) {
      <div class="mini-controls">
        <button type="button" class="mini-play-pause" (click)="player.togglePlayPause()" [attr.aria-label]="player.isPlaying() ? strings.BTN.PAUSE : strings.BTN.PLAY">
          @if (player.isPlaying()) {
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>
          } @else {
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7L8 5z"/></svg>
          }
        </button>
        <button type="button" class="mini-expand" (click)="toggleMiniMode()" [attr.aria-label]="strings.BTN.EXPAND_PLAYER" [attr.title]="strings.BTN.EXPAND_PLAYER">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
        </button>
      </div>
    }
  </div>

  @if (showQueue()) {
    <div class="queue-backdrop" (click)="toggleQueue()" aria-hidden="true"></div>
    <div class="queue-panel">
      <div class="queue-panel-header">
        <span class="queue-panel-title">{{ strings.SECTION.UP_NEXT }}</span>
        @if (player.queueList().length > 0) {
          <span class="queue-panel-duration">{{ formatDuration(totalQueueDuration()) }}</span>
          <button type="button" class="queue-panel-clear" (click)="onClearQueue()" [attr.aria-label]="strings.BTN.CLEAR_QUEUE" [attr.title]="strings.BTN.CLEAR_QUEUE">{{ strings.BTN.CLEAR }}</button>
        }
        <button type="button" class="queue-panel-close" (click)="toggleQueue()" [attr.aria-label]="strings.BTN.CLOSE_QUEUE">
          <svg class="icon icon-close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <ul class="queue-list">
        @if (player.queueList().length === 0) {
          <li class="queue-item queue-item-empty">{{ strings.EMPTY.QUEUE }}</li>
        } @else {
          @for (track of player.queueList(); track track.id; let i = $index) {
            <li
              class="queue-item"
              [class.queue-item-current]="isCurrentTrack(track.id)"
              (click)="playFromQueue(i)"
              role="button"
              tabindex="0"
              (keydown.enter)="playFromQueue(i)"
              (keydown.space)="playFromQueue(i); $event.preventDefault()"
            >
              <div class="queue-item-cover">
                @if (queueCoverErrors().has(track.id)) {
                  <span class="queue-cover-fallback" aria-hidden="true">♪</span>
                } @else {
                  <img [src]="coverUrl(track)" [alt]="track.title" (error)="onQueueCoverError(track.id)" />
                }
              </div>
              <span class="queue-item-index">{{ i + 1 }}</span>
              @if (isCurrentTrack(track.id) && player.isPlaying()) {
                <span class="queue-now-playing-anim" aria-hidden="true">
                  <span class="eq-bar"></span>
                  <span class="eq-bar"></span>
                  <span class="eq-bar"></span>
                </span>
              }
              <span class="queue-item-title">{{ track.title }}</span>
              @if (track.artist) {
                <span class="queue-item-artist">{{ track.artist }}</span>
              }
              <span class="queue-item-duration">{{ formatDuration(track.duration) }}</span>
              <button
                type="button"
                class="queue-item-remove-btn"
                (click)="removeFromQueue(i); $event.stopPropagation()"
                [attr.aria-label]="strings.BTN.REMOVE_FROM_QUEUE"
                [attr.title]="strings.BTN.REMOVE_FROM_QUEUE"
              >
                <svg class="icon icon-close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12"/></svg>
              </button>
              <button
                type="button"
                class="queue-item-add-btn"
                (click)="openQueueAddToPlaylist(track.id, $event)"
                [attr.aria-expanded]="queueAddToPlaylistTrackId() === track.id"
                [attr.aria-label]="strings.SECTION.ADD_TO_PLAYLIST"
                [attr.title]="strings.SECTION.ADD_TO_PLAYLIST"
              >
                <svg class="icon icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><path d="M12 5v14M5 12h14"/></svg>
              </button>
              @if (queueAddToPlaylistTrackId() === track.id) {
                <div class="queue-add-dropdown" (click)="$event.stopPropagation()">
                  <p class="queue-dropdown-title">{{ strings.SECTION.ADD_TO_PLAYLIST }}</p>
                  @if (playlistService.playlistsList().length === 0) {
                    <p class="queue-dropdown-empty">{{ strings.EMPTY.PLAYLISTS_NO_PLAYLISTS }}</p>
                  } @else {
                    @for (playlist of playlistService.playlistsList(); track playlist.id) {
                      <button
                        type="button"
                        class="queue-dropdown-item"
                        (click)="addQueueTrackToPlaylist(playlist.id, track.id)"
                      >
                        {{ playlist.name }}
                      </button>
                    }
                  }
                  <button
                    type="button"
                    class="queue-dropdown-item queue-dropdown-item-new"
                    (click)="createPlaylistAndAddQueueTrack(track.id)"
                  >
                    {{ strings.BTN.CREATE_NEW_PLAYLIST }}
                  </button>
                </div>
              }
            </li>
          }
        }
      </ul>
      <div class="queue-panel-footer">
        <label class="crossfade-label">
          {{ strings.LABEL.CROSSFADE }}
          <input
            type="range"
            class="crossfade-slider"
            min="0"
            max="12"
            step="1"
            [value]="player.crossfadeDuration()"
            (input)="player.setCrossfadeDuration($any($event.target).valueAsNumber)"
            [attr.aria-label]="strings.BTN.CROSSFADE_DURATION"
          />
          <span class="crossfade-value">{{ player.crossfadeDuration() }}s</span>
        </label>
        <!-- F1: Sleep Timer -->
        <div class="sleep-timer-wrap">
          @if (sleepTimer.isActive()) {
            <span class="sleep-timer-countdown">{{ strings.LABEL.SLEEP }} {{ formatTimer(sleepTimer.remainingSeconds()) }}</span>
            <button type="button" class="sleep-timer-cancel" (click)="cancelSleepTimer()">{{ strings.BTN.SLEEP_TIMER_CANCEL }}</button>
          } @else {
            <div class="sleep-timer-trigger-wrap">
              <button type="button" class="sleep-timer-trigger" (click)="toggleSleepTimerMenu(); $event.stopPropagation()">
                <svg class="icon icon-sleep" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12.34 2.02C6.59 1.82 2 6.42 2 12c0 5.52 4.48 10 10 10 3.71 0 6.93-2.02 8.66-5.02-7.51-.25-12.09-8.43-8.32-14.96z"/></svg>
                {{ strings.BTN.SLEEP_TIMER }}
              </button>
              @if (sleepTimerMenuOpen()) {
                <div class="sleep-timer-menu" (click)="$event.stopPropagation()">
                  <button type="button" class="sleep-timer-option" (click)="startSleepTimer(15)">{{ strings.SLEEP_TIMER.MIN_15 }}</button>
                  <button type="button" class="sleep-timer-option" (click)="startSleepTimer(30)">{{ strings.SLEEP_TIMER.MIN_30 }}</button>
                  <button type="button" class="sleep-timer-option" (click)="startSleepTimer(60)">{{ strings.SLEEP_TIMER.MIN_60 }}</button>
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>
  }
}
